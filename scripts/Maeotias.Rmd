---
title: "Maeotias"
author: "Caroline Newell"
date: "1/26/2022"
output: word_document
editor_options: 
  chunk_output_type: console
---
```{r}
library(tidyverse)
library(readxl)
library(lubridate)
library(ggplot2)
library(lfstat)

MaeotiasQuery2022 <- read_excel("data/MaeotiasQuery2022.xlsx")
range(MaeotiasQuery2022$SampleDate)
DeltaFlow_WaterYears1960_2021 <- read_csv("data/DeltaFlow_WaterYears1960_2021.csv")

drought_years<-c(1976, 1977, 1987, 1988, 1989, 1990, 1991, 1992, 2007, 2008, 2009, 2012, 2013, 2014, 2015, 2016, 2020, 2021) #data from: https://water.ca.gov/water-basics/drought  and Peter (2020, 2021)
```
The data isn't exactly what I want, so I'll have to format a bit. I only want flow data that relates to the SMFS data - which only goes back to 1981. So lets parse down the flow data to the 1981 water year and give Maeotias data a water year. Water years start Oct. 1st of the year prior to the reference year...
# Parsing Flows
Only care about outflow since that is what impacts the jellies.
```{r}
DeltaFlow_WY.1981_2021<- DeltaFlow_WaterYears1960_2021 %>% 
  filter(Date >="1980-10-01") %>% 
  mutate(WaterYear = water_year(Date, origin = "usgs")) %>% 
  group_by(WaterYear) %>% 
  summarise(Outflow_MAF = sum(OUT*1.983)/1000000) #24 hours at 1 cfs  = 1.983 acre feet
str(DeltaFlow_WY.1981_2021) #Need water year to be viewed as an integer.

DeltaFlow_WY.1981_2021$WaterYear<-format(DeltaFlow_WY.1981_2021$WaterYear, format = "%Y")

DeltaFlow_WY.1981_2021$WaterYear<-lubridate::year(DeltaFlow_WY.1981_2021$WaterYear)
  
  #year(as.Date(as.character(DeltaFlow_WY.1981_2021$WaterYear), format="%Y")) #Recognizing year as number I guess.
```

Now I need to append flow information to the jellyfish catch data. I can do that by giving the jellyfish catch data a column for water year and then match that column to my outflow stuff.
```{r}
#Adding water year to jelly data
MaeotiasQuery2022<-MaeotiasQuery2022 %>% mutate(WaterYear = water_year(SampleDate, origin = "usgs"))

str(MaeotiasQuery2022)

#Appending flow info to jelly data
Maeotias2022<-full_join(MaeotiasQuery2022, DeltaFlow_WY.1981_2021, by="WaterYear") #Lovely! Write that up!

write.csv(Maeotias2022, "data/Maeotias2022_WithOutflow.csv")

Maeotias2022$WaterYear<-format(MaeotiasQuery2022$WaterYear, format = "%Y")
```

```{r}
str(Maeotias2022)
Maeotias2022$WaterYear<- as.Date(as.character(Maeotias2022$WaterYear), format = "%Y")
Maeotias2022$WaterYear<- lubridate::year(Maeotias2022$WaterYear)

Maeotias2022$Month<- format(Maeotias2022$SampleDate, format = "%m")

write.csv(Maeotias2022, "data/Maeotias2022_WithOutflow_YearNumeric.csv")


ggplot(data = Maeotias2022, aes(x=WaterYear, y = Count)) +  geom_rect(aes(xmin=1987, xmax=1992, ymin=0, ymax=Inf),fill = "grey75", alpha = .1) +
  geom_rect(aes(xmin=2007, xmax=2009, ymin=0, ymax=Inf),fill = "grey75", alpha = .1) +
  geom_rect(aes(xmin=2012, xmax=2016, ymin=0, ymax=Inf),fill = "grey75", alpha = .1)+
  geom_rect(aes(xmin=2020, xmax=2021, ymin=0, ymax=Inf),fill = "grey75", alpha = .1)+
  stat_summary(fun=sum, geom = "bar")+ xlab("Water Year") +  ylab("Count") + ggtitle("SMFS Total Catch of M. marginata")+ scale_x_continuous(breaks=c(1980, 1990, 2000, 2010, 2020))+
  theme_classic(base_size=16) 

ggplot(data = Maeotias2022, aes(x=Month, y = Count)) +
  stat_summary(fun=sum, geom = "bar")

ggplot(data = Maeotias2022, aes(x=StationCode, y = Count)) +
  stat_summary(fun=sum, geom = "bar")
```

Lets bring delta outflow into the mix. Plot net delta outflow at Chipps Island
```{r}
#sum by water year
df <- DeltaFlow1960_2021 %>% mutate(WaterYear = water_year(Date, origin = "usgs"))
DeltaFlow1960_2021_WaterYear<-df %>% group_by(WaterYear) %>% summarise(Outflow_MAF = sum(OUT*1.983)/1000000) #24 hours at 1 cfs  = 1.983 acre feet
DeltaFlow1960_2021_WaterYear$WaterYear<- as.Date(as.character(DeltaFlow1960_2021_WaterYear$WaterYear), format="%Y")
#Only plot for years we have catch data for...

```